<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام رصد غياب الطلبة</title>
    <style>
        /* أنماط الجسم والخلفية - كما هي */
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, 
                #667eea 0%, 
                #764ba2 12.5%, 
                #f093fb 25%, 
                #f5556c 37.5%, /* تعديل طفيف في لون الخلفية الأصلية */
                #4facfe 50%, 
                #00f2fe 62.5%, 
                #43e97b 75%, 
                #38f9d7 87.5%, 
                #667eea 100%);
            background-size: 800% 800%;
            animation: gradientShift 20s ease infinite;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
        }
        
        html {
            height: 100%;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 0%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }

        /* أنماط الترويسة والعناصر الرئيسية - كما هي */
        .school-header {
            background: linear-gradient(135deg, 
                #667eea 0%, 
                #764ba2 20%, 
                #f093fb 40%, 
                #f5576c 60%, 
                #4facfe 80%, 
                #00f2fe 100%);
            background-size: 400% 400%;
            animation: headerFlow 15s ease infinite;
            padding: 3rem 3rem;
            box-shadow: 
                0 25px 60px rgba(102, 126, 234, 0.3),
                0 10px 30px rgba(240, 147, 251, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.2),
                inset 0 -2px 0 rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border-radius: 0 0 50px 50px;
        }

        /* ... (بقية أنماط الترويسة - تم حذف الإطناب) ... */
        @keyframes headerFlow {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 100% 0%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        .school-info {
            flex: 1;
            text-align: center;
            margin: 0 2rem;
            position: relative;
        }
        .school-name {
            font-size: 2.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 30%, #e2e8f0 70%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 0.4rem 0;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
            position: relative;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        .school-subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.95);
            margin: 0;
            font-weight: 600;
            line-height: 1.5;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }
        .principal-info {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.85);
            margin: 0.4rem 0 0 0;
            font-weight: 500;
            font-style: italic;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }
        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 35px;
            box-shadow: 
                0 40px 80px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.6),
                inset 0 -2px 0 rgba(0, 0, 0, 0.05);
            padding: 4rem;
            text-align: center;
            max-width: 520px;
            width: 90%;
            position: relative;
            z-index: 1;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                #667eea 0%, #764ba2 16.66%, #f093fb 33.33%, #f5576c 50%, #4facfe 66.66%, #00f2fe 83.33%, #43e97b 100%);
            background-size: 300% 100%;
            animation: containerGradient 8s ease infinite;
            border-radius: 35px 35px 0 0;
        }
        @keyframes containerGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .header {
            margin-bottom: 3.5rem;
        }
        .logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, 
                #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #43e97b 100%);
            background-size: 300% 300%;
            animation: logoGradient 6s ease infinite;
            border-radius: 30px;
            margin: 0 auto 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.2rem;
            box-shadow: 
                0 20px 45px rgba(102, 126, 234, 0.4),
                0 0 0 3px rgba(255, 255, 255, 0.3),
                inset 0 3px 0 rgba(255, 255, 255, 0.3),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        @keyframes logoGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .title {
            font-size: 2.4rem;
            font-weight: 800;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.8rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .subtitle {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 0;
            font-weight: 500;
            line-height: 1.6;
        }
        .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 2.5rem;
            max-width: 100%;
            width: 100%;
        }
        .role-button {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 1.2rem;
            padding: 1.2rem 1.8rem;
            border: none;
            border-radius: 18px;
            font-size: 1.1rem;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            min-height: 70px;
            width: 100%;
            text-align: left;
        }

        .role-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
            transition: left 0.6s ease;
        }

        .role-button:hover::before {
            left: 100%;
        }
        .teacher-button-style {
            background: linear-gradient(135deg, #10b981 0%, #059669 30%, #047857 70%, #065f46 100%);
            color: white;
            box-shadow: 
                0 15px 40px rgba(16, 185, 129, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.2), inset 0 -2px 0 rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .teacher-button-style:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 
                0 30px 60px rgba(16, 185, 129, 0.5), 0 0 0 3px rgba(16, 185, 129, 0.3),
                0 0 20px rgba(16, 185, 129, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, #34d399 0%, #10b981 30%, #059669 70%, #047857 100%);
        }
        .view-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 30%, #1d4ed8 70%, #1e40af 100%);
            color: white;
            box-shadow: 
                0 15px 40px rgba(59, 130, 246, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.2), inset 0 -2px 0 rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .view-button:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 
                0 30px 60px rgba(59, 130, 246, 0.5), 0 0 0 3px rgba(59, 130, 246, 0.3),
                0 0 20px rgba(59, 130, 246, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 30%, #2563eb 70%, #1d4ed8 100%);
        }
        .admin-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 30%, #b91c1c 70%, #991b1b 100%);
            color: white;
            box-shadow: 
                0 15px 40px rgba(239, 68, 68, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.2), inset 0 -2px 0 rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .admin-button:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 
                0 30px 60px rgba(239, 68, 68, 0.5), 0 0 0 3px rgba(239, 68, 68, 0.3),
                0 0 20px rgba(239, 68, 68, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, #f87171 0%, #ef4444 30%, #dc2626 70%, #b91c1c 100%);
        }
        .stats-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 30%, #6d28d9 70%, #5b21b6 100%);
            color: white;
            box-shadow: 
                0 15px 40px rgba(139, 92, 246, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.2), inset 0 -2px 0 rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .stats-button:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 
                0 30px 60px rgba(139, 92, 246, 0.5), 0 0 0 3px rgba(139, 92, 246, 0.3),
                0 0 20px rgba(139, 92, 246, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 30%, #7c3aed 70%, #6d28d9 100%);
        }
        .documentation-button {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 30%, #b45309 70%, #92400e 100%);
            color: white;
            box-shadow: 
                0 15px 40px rgba(245, 158, 11, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.2), inset 0 -2px 0 rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        .documentation-button:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 
                0 30px 60px rgba(245, 158, 11, 0.5), 0 0 0 3px rgba(245, 158, 11, 0.3),
                0 0 20px rgba(245, 158, 11, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 30%, #d97706 70%, #b45309 100%);
        }
        .icon {
            font-size: 2.2rem;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.25));
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.1) 100%);
            border-radius: 15px;
            backdrop-filter: blur(20px);
            border: 3px solid rgba(255, 255, 255, 0.5);
            animation: iconFloat 4s ease-in-out infinite;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.15), 0 3px 10px rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.4), inset 0 -2px 0 rgba(0, 0, 0, 0.1);
        }
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); }
            25% { transform: translateY(-8px) rotate(3deg) scale(1.05); }
            50% { transform: translateY(-4px) rotate(-2deg) scale(1.03); }
            75% { transform: translateY(-10px) rotate(4deg) scale(1.07); }
        }
        .role-button:hover .icon {
            transform: scale(1.3) rotate(15deg) translateY(-12px);
            filter: drop-shadow(0 15px 30px rgba(0, 0, 0, 0.4));
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.6) 0%, rgba(255, 255, 255, 0.4) 50%, rgba(255, 255, 255, 0.2) 100%);
            border-color: rgba(255, 255, 255, 0.8);
            border-width: 5px;
            animation: iconBounce 1s ease-in-out;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.3), 0 10px 25px rgba(0, 0, 0, 0.15),
                inset 0 4px 0 rgba(255, 255, 255, 0.5), inset 0 -4px 0 rgba(0, 0, 0, 0.15),
                0 0 40px rgba(255, 255, 255, 0.4);
        }
        @keyframes iconBounce {
            0%, 100% { transform: scale(1.25) rotate(12deg) translateY(-8px); }
            25% { transform: scale(1.35) rotate(-6deg) translateY(-15px); }
            50% { transform: scale(1.3) rotate(18deg) translateY(-10px); }
            75% { transform: scale(1.28) rotate(-3deg) translateY(-12px); }
        }

        /* تنسيقات الـ Modal العادية (لكلمات المرور) - كما هي */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        /* تنسيق الـ Modal الخاص بالإطارات (Iframe Modal) */
        .iframe-modal {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
        }

        .iframe-modal-content {
            background: white;
            border-radius: 25px;
            max-width: 95%;
            max-height: 95%;
            width: 1400px;
            height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        .iframe-modal.show .iframe-modal-content {
            transform: scale(1);
        }

        .iframe-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            min-height: 70px;
        }

        .iframe-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .iframe-content {
            flex: 1;
            overflow: hidden;
        }
        
        /* إطار الموقع الخارجي */
        #siteIframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* زر الرجوع (Back Button) */
        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }


        /* ... (بقية أنماط الـ data-modal كما هي) ... */
        .data-modal {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        .data-modal-content {
            background: white;
            border-radius: 25px;
            max-width: 95%;
            max-height: 90%;
            width: 1200px;
            height: 80%;
            display: flex;
            flex-direction: column;
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        .data-modal.show .data-modal-content {
            transform: scale(1);
        }
        .data-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }
        .data-title {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .data-controls {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        /* ... (بقية أنماط عناصر التحكم والجداول كما هي) ... */


        /* Media Queries (للتوافق مع الأجهزة) */
        @media (max-width: 768px) {
            /* ... (تنسيقات الأجهزة اللوحية - كما هي) ... */
            .iframe-modal-content {
                width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
            }
            .iframe-header {
                padding: 0.8rem 1rem;
                min-height: 50px;
            }
            .iframe-title {
                font-size: 1.2rem;
            }
            .back-btn {
                font-size: 0.8rem;
                padding: 0.6rem 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="school-header">
        <div class="header-content">
            <div class="school-info">
                <h1 class="school-name">مدرسة أم مالك الأنصارية للبنات</h1>
                <p class="school-subtitle">تعليم متطور يوظف التقانة بكفاءة، مع تعلم مستدام و شراكة مجتمعية فاعلة</p>
                <p class="principal-info">إعداد مديرة المدرسة: أحلام بنت علي الحمدانية</p>
            </div>
        </div>
    </header>

    <div class="main-content">
        <main class="container">
        <header class="header">
            <div class="logo">🎓</div>
            <h1 class="title">نظام رصد الغياب</h1>
            <p class="subtitle">منصة متطورة لإدارة حضور وغياب الطلبة</p>
        </header>

        <div class="buttons-container">
            <button class="role-button teacher-button-style" onclick="showIframeModal(TEACHER_URL, 'واجهة المعلم')">
                <span class="icon">🧑‍🏫</span>
                <span>دخول المعلم</span>
            </button>

            <button class="role-button view-button" onclick="showDataView()">
                <span class="icon">📊</span>
                <span>عرض بيانات الغياب</span>
            </button>

            <button class="role-button admin-button" onclick="showAdminPasswordModal()">
                <span class="icon">⚙️</span>
                <span>دخول الإدارة</span>
            </button>

            <button class="role-button stats-button" onclick="showStatsPasswordModal()">
                <span class="icon">📈</span>
                <span>الإحصائيات المتقدمة</span>
            </button>

            <button class="role-button documentation-button" onclick="showDocumentationView()">
                <span class="icon">📝</span>
                <span>التوثيق اليومي</span>
            </button>
        </div>

            <footer class="footer">
                <p>🔒 نظام آمن ومحمي • تطوير حديث</p>
            </footer>
        </main>
    </div>
    
    <div class="modal iframe-modal" id="iframeModal">
        <div class="iframe-modal-content">
            <div class="iframe-header">
                <button class="back-btn" onclick="hideIframeModal()">
                    <span class="icon" style="font-size: 1rem; width: 30px; height: 30px;">➡️</span>
                    رجوع للصفحة الرئيسية
                </button>
                <h2 class="iframe-title" id="iframeTitle"></h2>
            </div>
            <div class="iframe-content">
                <iframe id="siteIframe" src="" title="المحتوى الخارجي"></iframe>
            </div>
        </div>
    </div>


    <div class="modal" id="adminPasswordModal">
        <div class="modal-content">
            <h2 class="modal-title">🔐 دخول الإدارة</h2>
            <input type="password" 
                   class="password-input" 
                   id="adminPasswordInput" 
                   placeholder="أدخل كلمة المرور"
                   onkeypress="handlePasswordKeyPress(event, 'admin')">
            <div class="error-message" id="adminErrorMessage">كلمة المرور غير صحيحة</div>
            <div class="modal-buttons">
                <button class="modal-button confirm-btn" onclick="checkAdminPassword()">دخول</button>
                <button class="modal-button cancel-btn" onclick="hideAdminPasswordModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div class="modal" id="statsPasswordModal">
        <div class="modal-content">
            <h2 class="modal-title">📈 الإحصائيات المتقدمة</h2>
            <input type="password" 
                   class="password-input" 
                   id="statsPasswordInput" 
                   placeholder="أدخل كلمة المرور"
                   onkeypress="handlePasswordKeyPress(event, 'stats')">
            <div class="error-message" id="statsErrorMessage">كلمة المرور غير صحيحة</div>
            <div class="modal-buttons">
                <button class="modal-button confirm-btn" onclick="checkStatsPassword()">دخول</button>
                <button class="modal-button cancel-btn" onclick="hideStatsPasswordModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div class="modal data-modal" id="advancedStatsModal">
        <div class="data-modal-content">
            <div class="data-header">
                <h2 class="data-title">📈 الإحصائيات المتقدمة</h2>
                <div class="data-controls">
                    <div class="action-controls">
                        <button class="control-btn print-btn" onclick="printAdvancedStats()">
                            <span class="icon">🖨️</span>
                            طباعة
                        </button>
                        <button class="control-btn refresh-btn" onclick="refreshAdvancedStats()">
                            <span class="icon">🔄</span>
                            تحديث
                        </button>
                        <button class="control-btn close-btn" onclick="hideAdvancedStats()">
                            <span class="icon">✖️</span>
                            إغلاق
                        </button>
                    </div>
                </div>
            </div>
            <div class="data-content" id="advancedStatsContent">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>جاري تحليل البيانات...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal data-modal" id="documentationModal">
        <div class="data-modal-content">
            <div class="data-header">
                <h2 class="data-title">📝 التوثيق اليومي</h2>
                <div class="data-controls">
                    <div class="date-filter">
                        <label for="docDateFilter" style="color: white; font-size: 0.9rem; margin-left: 0.5rem;">التاريخ:</label>
                        <input type="date" id="docDateFilter" class="date-input" onchange="filterDocumentationByDate()">
                        <button class="control-btn today-btn" onclick="setDocTodayDate()">
                            <span class="icon">📅</span>
                            اليوم
                        </button>
                        <button class="control-btn all-btn" onclick="showAllDocumentation()">
                            <span class="icon">📋</span>
                            الكل
                        </button>
                    </div>
                    <div class="action-controls">
                        <button class="control-btn print-btn" onclick="printDocumentation()">
                            <span class="icon">🖨️</span>
                            طباعة
                        </button>
                        <button class="control-btn refresh-btn" onclick="refreshDocumentation()">
                            <span class="icon">🔄</span>
                            تحديث
                        </button>
                        <button class="control-btn close-btn" onclick="hideDocumentationView()">
                            <span class="icon">✖️</span>
                            إغلاق
                        </button>
                    </div>
                </div>
            </div>
            <div class="data-content" id="documentationContent">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>جاري تحميل التوثيق اليومي...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal data-modal" id="dataModal">
        <div class="data-modal-content">
            <div class="data-header">
                <h2 class="data-title">📊 بيانات غياب الطلبة</h2>
                <div class="data-controls">
                    <div class="date-filter">
                        <label for="dateFilter" style="color: white; font-size: 0.9rem; margin-left: 0.5rem;">التاريخ:</label>
                        <input type="date" id="dateFilter" class="date-input" onchange="filterByDate()">
                        <button class="control-btn today-btn" onclick="setTodayDate()">
                            <span class="icon">📅</span>
                            اليوم
                        </button>
                        <button class="control-btn all-btn" onclick="showAllData()">
                            <span class="icon">📋</span>
                            الكل
                        </button>
                    </div>
                    <div class="action-controls">
                        <button class="control-btn print-btn" onclick="printData()">
                            <span class="icon">🖨️</span>
                            طباعة
                        </button>
                        <button class="control-btn refresh-btn" onclick="refreshData()">
                            <span class="icon">🔄</span>
                            تحديث
                        </button>
                        <button class="control-btn close-btn" onclick="hideDataView()">
                            <span class="icon">✖️</span>
                            إغلاق
                        </button>
                    </div>
                </div>
            </div>
            <div class="data-content" id="dataContent">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>جاري تحميل البيانات...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // الروابط الخارجية
        const TEACHER_URL = 'https://script.google.com/macros/s/AKfycbwTdo7sJOuRReoZ6znfQrGhPN0NwLpH9-CmenhX1zJj-TqIYH--hrw0dt3PkfBIKsShqg/exec?view=teacher';
        const ADMIN_URL = 'https://script.google.com/macros/s/AKfycbwTdo7sJOuRReoZ6znfQrGhPN0NwLpH9-CmenhX1zJj-TqIYH--hrw0dt3PkfBIKsShqg/exec';
        
        // كلمات المرور الافتراضية
        const ADMIN_PASSWORD = 'admin123';
        const STATS_PASSWORD = 'admin123';

        // ----------------------------------------------------------------------
        // # دوال التحكم بالـ IFRAME (للمعلم والإدارة)
        // ----------------------------------------------------------------------
        
        function showIframeModal(url, title) {
            const modal = document.getElementById('iframeModal');
            const iframe = document.getElementById('siteIframe');
            const modalTitle = document.getElementById('iframeTitle');
            
            modalTitle.textContent = title;
            iframe.src = url;

            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        function hideIframeModal() {
            const modal = document.getElementById('iframeModal');
            const iframe = document.getElementById('siteIframe');
            
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                iframe.src = ''; // مسح الرابط لإيقاف تشغيل المحتوى
            }, 300);
        }

        // ----------------------------------------------------------------------
        // # دوال الدخول (الإدارة)
        // ----------------------------------------------------------------------

        // 1. دخول الإدارة
        function showAdminPasswordModal() {
            const modal = document.getElementById('adminPasswordModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            document.getElementById('adminPasswordInput').focus();
        }

        function hideAdminPasswordModal() {
            const modal = document.getElementById('adminPasswordModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminErrorMessage').style.display = 'none';
            }, 300);
        }

        function checkAdminPassword() {
            const password = document.getElementById('adminPasswordInput').value;
            const errorMessage = document.getElementById('adminErrorMessage');
            
            if (password === ADMIN_PASSWORD) {
                hideAdminPasswordModal();
                // فتح رابط الإدارة داخل الإطار في نفس الصفحة
                showIframeModal(ADMIN_URL, 'واجهة الإدارة');
            } else {
                errorMessage.style.display = 'block';
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminPasswordInput').focus();
            }
        }
        
        // 2. دخول الإحصائيات (لم يتغير سوى اسم دالة التحقق)
        function showStatsPasswordModal() {
            const modal = document.getElementById('statsPasswordModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            document.getElementById('statsPasswordInput').focus();
        }

        function hideStatsPasswordModal() {
            const modal = document.getElementById('statsPasswordModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('statsPasswordInput').value = '';
                document.getElementById('statsErrorMessage').style.display = 'none';
            }, 300);
        }

        function checkStatsPassword() {
            const password = document.getElementById('statsPasswordInput').value;
            const errorMessage = document.getElementById('statsErrorMessage');
            
            if (password === STATS_PASSWORD) { 
                hideStatsPasswordModal();
                showAdvancedStats(); // يفتح النافذة الداخلية
            } else {
                errorMessage.style.display = 'block';
                document.getElementById('statsPasswordInput').value = '';
                document.getElementById('statsPasswordInput').focus();
            }
        }

        // دالة موحدة للضغط على زر Enter
        function handlePasswordKeyPress(event, role) {
            if (event.key === 'Enter') {
                if (role === 'admin') {
                    checkAdminPassword();
                } else if (role === 'stats') {
                    checkStatsPassword();
                }
            }
        }
        
        // إخفاء نوافذ كلمات المرور عند النقر خارجها
        document.getElementById('adminPasswordModal').addEventListener('click', function(event) {
            if (event.target === this) {
                hideAdminPasswordModal();
            }
        });

        document.getElementById('statsPasswordModal').addEventListener('click', function(event) {
            if (event.target === this) {
                hideStatsPasswordModal();
            }
        });

        document.getElementById('iframeModal').addEventListener('click', function(event) {
            if (event.target === this) {
                hideIframeModal();
            }
        });

        // ----------------------------------------------------------------------
        // # بقية الدوال (عرض البيانات، الإحصائيات، التوثيق) - لم يتم تغييرها
        // ----------------------------------------------------------------------

        // وظائف عرض البيانات
        function showDataView() {
            const modal = document.getElementById('dataModal');
            modal.style.display = 'flex';
            setTimeout(() => { modal.classList.add('show'); }, 10);
            loadData();
        }

        function hideDataView() {
            const modal = document.getElementById('dataModal');
            modal.classList.remove('show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function loadData() {
            const dataContent = document.getElementById('dataContent');
            dataContent.innerHTML = `<div class="loading-spinner"><div class="spinner"></div><p>جاري تحميل البيانات من الشيت...</p></div>`;
            fetchDataFromSheets();
        }

        let allStudentsData = [];

        async function fetchDataFromSheets() {
            try {
                const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTBKjdsCS_LNw-kqD-zFmsd-TuW7d-O4DOb9Cs-n1pP9U4oRz3l0mzM4VzGif1wM-S0mF7wW2bP6FxW/pub?gid=603685106&single=true&output=csv';
                const response = await fetch(sheetUrl);
                const csvText = await response.text();
                const data = parseCSVData(csvText);
                allStudentsData = data; 
                displayRealData(data);
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                displayErrorMessage();
            }
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const students = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const values = line.split(',');
                    if (values.length >= 5) {
                        students.push({
                            timestamp: values[0] || '', teacherName: values[1] || '', studentName: values[2] || '', className: values[3] || '', reason: values[4] || ''
                        });
                    }
                }
            }
            return students;
        }

        function displayRealData(students, selectedDate = null) {
            const dataContent = document.getElementById('dataContent');
            const totalAbsent = students.length;
            const uniqueStudents = [...new Set(students.map(s => s.studentName))].length;
            
            let dateMessage = '';
            if (selectedDate) {
                const dateObj = new Date(selectedDate + 'T12:00:00+04:00');
                const gregorianDate = dateObj.toLocaleDateString('ar-OM', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                dateMessage = `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 1.5rem; text-align: center; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);"><h4 style="margin: 0 0 0.5rem 0; font-size: 1.2rem;">📅 بيانات الغياب المفلترة</h4><div style="font-size: 1.1rem; font-weight: 600;">📆 ${gregorianDate}</div></div>`;
            }
            
            if (students.length === 0) {
                const noDataMessage = selectedDate ? `لا توجد حالات غياب مسجلة في التاريخ المحدد` : `لم يتم تسجيل أي حالات غياب بعد`;
                dataContent.innerHTML = `${dateMessage}<div style="text-align: center; padding: 3rem; color: #64748b;"><div style="font-size: 4rem; margin-bottom: 1rem;">📋</div><h3>لا توجد بيانات غياب</h3><p>${noDataMessage}</p>${selectedDate ? '<button class="control-btn all-btn" onclick="showAllData()" style="margin-top: 1rem;"><span class="icon">📋</span> عرض جميع البيانات</button>' : ''}</div>`;
                return;
            }

            dataContent.innerHTML = `
                ${dateMessage}
                <div class="stats-container">
                    <div class="stat-card total-students"><div class="stat-number">${totalAbsent}</div><div class="stat-label">إجمالي حالات الغياب</div></div>
                    <div class="stat-card absent-students"><div class="stat-number">${uniqueStudents}</div><div class="stat-label">عدد الطالبات الغائبات</div></div>
                    <div class="stat-card present-students"><div class="stat-number">${students.filter(s => s.reason.includes('مرض')).length}</div><div class="stat-label">غياب بسبب المرض</div></div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr><th>وقت التسجيل</th><th>اسم المعلمة</th><th>اسم الطالبة</th><th>الفصل</th><th>سبب الغياب</th></tr>
                    </thead>
                    <tbody>
                        ${students.map(student => `
                            <tr>
                                <td style="line-height: 1.4;">${formatTimestamp(student.timestamp)}</td>
                                <td>${student.teacherName}</td>
                                <td><strong>${student.studentName}</strong></td>
                                <td>${student.className}</td>
                                <td><span class="absent-mark">${student.reason}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="text-align: center; color: #64748b; font-size: 0.9rem; margin-top: 2rem;">
                    <p>📅 آخر تحديث: ${new Date().toLocaleDateString('ar-OM')} - ${new Date().toLocaleTimeString('ar-OM')}</p>
                    <p>🏫 مدرسة أم مالك الأنصارية للبنات</p>
                    <p>📊 ${selectedDate ? 'السجلات المعروضة' : 'إجمالي السجلات'}: ${students.length}</p>
                    ${selectedDate ? `<p>📋 <a href="#" onclick="showAllData()" style="color: #667eea; text-decoration: none;">عرض جميع البيانات</a></p>` : ''}
                </div>
            `;
        }

        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                const omanTime = new Date(date.getTime() + (4 * 60 * 60 * 1000));
                const gregorianDate = omanTime.toLocaleDateString('ar-OM', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
                const time = omanTime.toLocaleTimeString('ar-OM', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                return `<div style="text-align: center; line-height: 1.4;"><div style="color: #1e40af; font-weight: 600; font-size: 0.95rem; margin-bottom: 4px;">${gregorianDate}</div><div style="color: #10b981; font-weight: 600; font-size: 0.9rem; background: rgba(16, 185, 129, 0.1); padding: 4px 8px; border-radius: 8px; display: inline-block;">${time}</div></div>`;
            } catch (error) {
                return `<div style="color: #ef4444; font-size: 0.8rem;">خطأ في التاريخ</div>`;
            }
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFilter').value = today;
            filterByDate();
        }

        function showAllData() {
            document.getElementById('dateFilter').value = '';
            displayRealData(allStudentsData);
        }

        function filterByDate() {
            const selectedDate = document.getElementById('dateFilter').value;
            if (!selectedDate) {
                displayRealData(allStudentsData);
                return;
            }

            const filteredData = allStudentsData.filter(student => {
                try {
                    const studentDate = new Date(student.timestamp);
                    const omanTime = new Date(studentDate.getTime() + (4 * 60 * 60 * 1000));
                    const studentDateString = omanTime.toISOString().split('T')[0];
                    return studentDateString === selectedDate;
                } catch (error) {
                    return false;
                }
            });

            displayRealData(filteredData, selectedDate);
        }

        function displayErrorMessage() {
            const dataContent = document.getElementById('dataContent');
            dataContent.innerHTML = `<div style="text-align: center; padding: 3rem; color: #ef4444;"><div style="font-size: 4rem; margin-bottom: 1rem;">⚠️</div><h3>خطأ في تحميل البيانات</h3><p>لم نتمكن من تحميل البيانات من الشيت</p><button class="control-btn refresh-btn" onclick="loadData()" style="margin-top: 1rem;"><span class="icon">🔄</span>إعادة المحاولة</button></div>`;
        }

        function refreshData() {
            loadData();
        }

        function printData() {
            createPrintContent();
            setTimeout(() => { window.print(); }, 500);
        }

        function createPrintContent() {
            const existingPrintContent = document.querySelector('.print-content');
            if (existingPrintContent) { existingPrintContent.remove(); }

            const dateFilter = document.getElementById('dateFilter').value;
            let dataToPrint = allStudentsData;
            let dateTitle = 'جميع البيانات';
            
            if (dateFilter) {
                dataToPrint = allStudentsData.filter(student => {
                    try {
                        const studentDate = new Date(student.timestamp);
                        const omanTime = new Date(studentDate.getTime() + (4 * 60 * 60 * 1000));
                        const studentDateString = omanTime.toISOString().split('T')[0];
                        return studentDateString === dateFilter;
                    } catch (error) { return false; }
                });
                
                const dateObj = new Date(dateFilter + 'T12:00:00+04:00');
                dateTitle = dateObj.toLocaleDateString('ar-OM', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            }

            const totalAbsent = dataToPrint.length;
            const uniqueStudents = [...new Set(dataToPrint.map(s => s.studentName))].length;
            const sickAbsent = dataToPrint.filter(s => s.reason.includes('مرض')).length;

            const printContent = document.createElement('div');
            printContent.className = 'print-content';
            printContent.style.display = 'none'; 
            
            printContent.innerHTML = `
                <div class="print-header">
                    <div class="print-school-name">مدرسة أم مالك الأنصارية للبنات</div>
                    <div class="print-title">📊 تقرير غياب الطلبة</div>
                    <div class="print-date">📅 ${dateTitle}</div>
                    <div class="print-date">تاريخ الطباعة: ${new Date().toLocaleDateString('ar-OM')} - ${new Date().toLocaleTimeString('ar-OM')}</div>
                </div>
                <div class="print-stats">
                    <div class="print-stat"><span class="print-stat-number">${totalAbsent}</span><div class="print-stat-label">إجمالي حالات الغياب</div></div>
                    <div class="print-stat"><span class="print-stat-number">${uniqueStudents}</span><div class="print-stat-label">عدد الطالبات الغائبات</div></div>
                    <div class="print-stat"><span class="print-stat-number">${sickAbsent}</span><div class="print-stat-label">غياب بسبب المرض</div></div>
                </div>
                ${dataToPrint.length > 0 ? `
                <table class="print-table">
                    <thead>
                        <tr><th>وقت التسجيل</th><th>اسم المعلمة</th><th>اسم الطالبة</th><th>الفصل</th><th>سبب الغياب</th></tr>
                    </thead>
                    <tbody>
                        ${dataToPrint.map((student, index) => `
                            <tr>
                                <td><div class="print-timestamp">${formatTimestampForPrint(student.timestamp)}</div></td>
                                <td>${student.teacherName}</td><td><strong>${student.studentName}</strong></td><td>${student.className}</td>
                                <td><span class="print-absent-mark">${student.reason}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>` : `<div style="text-align: center; padding: 30pt; color: #64748b; border: 1pt solid #e2e8f0; margin: 20pt 0;"><div style="font-size: 16pt; margin-bottom: 10pt;">📋</div><div style="font-size: 14pt; font-weight: bold;">لا توجد بيانات غياب</div><div style="font-size: 12pt; margin-top: 5pt;">لم يتم تسجيل أي حالات غياب في التاريخ المحدد</div></div>`}
                <div class="print-footer"><div>🏫 مدرسة أم مالك الأنصارية للبنات</div><div>📧 إعداد مديرة المدرسة: أحلام بنت علي الحمدانية</div><div>📊 عدد السجلات المطبوعة: ${dataToPrint.length}</div><div style="margin-top: 10pt; font-size: 8pt;">تم إنشاء هذا التقرير بواسطة نظام رصد الغياب الإلكتروني</div></div>
            `;
            document.body.appendChild(printContent);
        }

        function formatTimestampForPrint(timestamp) {
            try {
                const date = new Date(timestamp);
                const omanTime = new Date(date.getTime() + (4 * 60 * 60 * 1000));
                const gregorianDate = omanTime.toLocaleDateString('ar-OM', { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' });
                const time = omanTime.toLocaleTimeString('ar-OM', { hour: '2-digit', minute: '2-digit', hour12: true });
                return `<div class="print-date-part">${gregorianDate}</div><div class="print-time-part">${time}</div>`;
            } catch (error) { return '<div style="color: #ef4444;">خطأ في التاريخ</div>'; }
        }

        // وظائف الإحصائيات المتقدمة 
        function showAdvancedStats() {
            const modal = document.getElementById('advancedStatsModal');
            modal.style.display = 'flex';
            setTimeout(() => { modal.classList.add('show'); }, 10);
            loadAdvancedStats();
        }

        function hideAdvancedStats() {
            const modal = document.getElementById('advancedStatsModal');
            modal.classList.remove('show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function loadAdvancedStats() {
            const statsContent = document.getElementById('advancedStatsContent');
            statsContent.innerHTML = `<div class="loading-spinner"><div class="spinner"></div><p>جاري تحليل البيانات وحساب الإحصائيات...</p></div>`;
            fetchAdvancedStatsData();
        }

        async function fetchAdvancedStatsData() {
            try {
                const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTBKjdsCS_LNw-kqD-zFmsd-TuW7d-O4DOb9Cs-n1pP9U4oRz3l0mzM4VzGif1wM-S0mF7wW2bP6FxW/pub?gid=603685106&single=true&output=csv';
                const response = await fetch(sheetUrl);
                const csvText = await response.text();
                const data = parseCSVData(csvText);
                analyzeAdvancedStats(data);
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                displayAdvancedStatsError();
            }
        }

        function analyzeAdvancedStats(students) {
            const classStats = {};
            students.forEach(student => {
                const className = student.className;
                if (classStats[className]) { classStats[className]++; } else { classStats[className] = 1; }
            });
            const sortedClasses = Object.entries(classStats).sort(([,a], [,b]) => b - a).slice(0, 10);

            const studentStats = {};
            students.forEach(student => {
                const key = `${student.studentName} - ${student.className}`;
                if (studentStats[key]) {
                    studentStats[key].count++;
                    studentStats[key].reasons.push(student.reason);
                } else {
                    studentStats[key] = { name: student.studentName, className: student.className, count: 1, reasons: [student.reason] };
                }
            });
            const sortedStudents = Object.values(studentStats).sort((a, b) => b.count - a.count).slice(0, 15);

            const reasonStats = {};
            students.forEach(student => {
                const reason = student.reason;
                if (reasonStats[reason]) { reasonStats[reason]++; } else { reasonStats[reason] = 1; }
            });
            const sortedReasons = Object.entries(reasonStats).sort(([,a], [,b]) => b - a);

            const dayStats = {};
            students.forEach(student => {
                try {
                    const date = new Date(student.timestamp);
                    const omanTime = new Date(date.getTime() + (4 * 60 * 60 * 1000));
                    const dayName = omanTime.toLocaleDateString('ar-OM', { weekday: 'long' });
                    if (dayStats[dayName]) { dayStats[dayName]++; } else { dayStats[dayName] = 1; }
                } catch (error) {}
            });
            const sortedDays = Object.entries(dayStats).sort(([,a], [,b]) => b - a);

            displayAdvancedStats(sortedClasses, sortedStudents, sortedReasons, sortedDays, students.length);
        }

        function displayAdvancedStats(topClasses, topStudents, topReasons, topDays, totalRecords) {
            const statsContent = document.getElementById('advancedStatsContent');
            statsContent.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 15px; text-align: center; margin-bottom: 2rem; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.4rem;">📊 تحليل شامل لبيانات الغياب</h3>
                        <p style="margin: 0; font-size: 1rem; opacity: 0.9;">إجمالي السجلات المحللة: ${totalRecords} سجل</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">تاريخ التحليل: ${new Date().toLocaleDateString('ar-OM')} - ${new Date().toLocaleTimeString('ar-OM')}</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                    <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0;"><h4 style="color: #ef4444; font-size: 1.3rem; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">🏫 أكثر الفصول غياباً</h4><div style="max-height: 400px; overflow-y: auto;">
                            ${topClasses.length > 0 ? topClasses.map((classData, index) => `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; margin-bottom: 0.5rem; background: ${index === 0 ? 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)' : index === 1 ? 'linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%)' : index === 2 ? 'linear-gradient(135deg, #fed7aa 0%, #fdba74 100%)' : '#f8fafc'}; border-radius: 10px; border-left: 4px solid ${index === 0 ? '#f59e0b' : index === 1 ? '#6b7280' : index === 2 ? '#ea580c' : '#3b82f6'};"><div><div style="font-weight: 600; color: #2d3748; font-size: 1rem;">${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`} ${classData[0]}</div></div><div style="background: ${index === 0 ? '#f59e0b' : index === 1 ? '#6b7280' : index === 2 ? '#ea580c' : '#3b82f6'}; color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">${classData[1]} حالة غياب</div></div>`).join('') : '<p style="text-align: center; color: #64748b; padding: 2rem;">لا توجد بيانات</p>'}
                        </div>
                    </div>

                    <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0;"><h4 style="color: #dc2626; font-size: 1.3rem; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">👩‍🎓 أكثر الطالبات غياباً</h4><div style="max-height: 400px; overflow-y: auto;">
                            ${topStudents.length > 0 ? topStudents.map((studentData, index) => `<div style="padding: 1rem; margin-bottom: 0.8rem; background: ${index === 0 ? 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)' : index === 1 ? 'linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%)' : index === 2 ? 'linear-gradient(135deg, #fed7aa 0%, #fdba74 100%)' : '#f8fafc'}; border-radius: 12px; border-left: 4px solid ${index === 0 ? '#f59e0b' : index === 1 ? '#6b7280' : index === 2 ? '#ea580c' : '#8b5cf6'}; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;"><div style="font-weight: 700; color: #2d3748; font-size: 1rem;">${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`} ${studentData.name}</div><div style="background: ${index === 0 ? '#f59e0b' : index === 1 ? '#6b7280' : index === 2 ? '#ea580c' : '#8b5cf6'}; color: white; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 600; font-size: 0.85rem;">${studentData.count} مرة</div></div><div style="font-size: 0.9rem; color: #4a5568; margin-bottom: 0.5rem;">📚 الفصل: ${studentData.className}</div><div style="font-size: 0.85rem; color: #64748b;">📝 الأسباب: ${[...new Set(studentData.reasons)].join(' • ')}</div></div>`).join('') : '<p style="text-align: center; color: #64748b; padding: 2rem;">لا توجد بيانات</p>'}
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                    <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0;"><h4 style="color: #7c3aed; font-size: 1.3rem; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">📋 أسباب الغياب</h4>
                        ${topReasons.length > 0 ? topReasons.map((reasonData, index) => `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 10px; border-left: 4px solid #7c3aed;"><div style="font-weight: 600; color: #2d3748;">${reasonData[0]}</div><div style="background: #7c3aed; color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">${reasonData[1]} حالة</div></div>`).join('') : '<p style="text-align: center; color: #64748b; padding: 2rem;">لا توجد بيانات</p>'}
                    </div>

                    <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0;"><h4 style="color: #059669; font-size: 1.3rem; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">📅 الغياب حسب أيام الأسبوع</h4>
                        ${topDays.length > 0 ? topDays.map((dayData, index) => `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 10px; border-left: 4px solid #059669;"><div style="font-weight: 600; color: #2d3748;">${dayData[0]}</div><div style="background: #059669; color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">${dayData[1]} حالة</div></div>`).join('') : '<p style="text-align: center; color: #64748b; padding: 2rem;">لا توجد بيانات</p>'}
                    </div>
                </div>

                <div style="text-align: center; color: #64748b; font-size: 0.9rem; margin-top: 2rem; padding: 1.5rem; background: #f8fafc; border-radius: 15px; border: 1px solid #e2e8f0;">
                    <p style="margin: 0 0 0.5rem 0;">🏫 <strong>مدرسة أم مالك الأنصارية للبنات</strong></p>
                    <p style="margin: 0 0 0.5rem 0;">📊 تقرير الإحصائيات المتقدمة - إعداد مديرة المدرسة: أحلام بنت علي الحمدانية</p>
                    <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">تم إنشاء هذا التقرير بواسطة نظام رصد الغياب الإلكتروني المتطور</p>
                </div>
            `;
        }

        function displayAdvancedStatsError() {
            const statsContent = document.getElementById('advancedStatsContent');
            statsContent.innerHTML = `<div style="text-align: center; padding: 3rem; color: #ef4444;"><div style="font-size: 4rem; margin-bottom: 1rem;">⚠️</div><h3>خطأ في تحليل البيانات</h3><p>لم نتمكن من تحميل البيانات وتحليلها</p><button class="control-btn refresh-btn" onclick="loadAdvancedStats()" style="margin-top: 1rem;"><span class="icon">🔄</span>إعادة المحاولة</button></div>`;
        }

        function refreshAdvancedStats() { loadAdvancedStats(); }
        function printAdvancedStats() { createAdvancedStatsPrintContent(); setTimeout(() => { window.print(); }, 500); }
        function createAdvancedStatsPrintContent() {
            const existingPrintContent = document.querySelector('.print-content');
            if (existingPrintContent) { existingPrintContent.remove(); }
            const statsContent = document.getElementById('advancedStatsContent').innerHTML;
            const printContent = document.createElement('div');
            printContent.className = 'print-content';
            printContent.style.display = 'none';
            printContent.innerHTML = `<div class="print-header"><div class="print-school-name">مدرسة أم مالك الأنصارية للبنات</div><div class="print-title">📈 تقرير الإحصائيات المتقدمة</div><div class="print-date">تاريخ الطباعة: ${new Date().toLocaleDateString('ar-OM')} - ${new Date().toLocaleTimeString('ar-OM')}</div></div><div style="margin-top: 20pt;">${statsContent}</div><div class="print-footer"><div>🏫 مدرسة أم مالك الأنصارية للبنات</div><div>📧 إعداد مديرة المدرسة: أحلام بنت علي الحمدانية</div><div style="margin-top: 10pt; font-size: 8pt;">تم إنشاء هذا التقرير بواسطة نظام رصد الغياب الإلكتروني المتطور</div></div>`;
            document.body.appendChild(printContent);
        }

        // وظائف التوثيق اليومي 
        let allDocumentationData = [];

        function showDocumentationView() {
            const modal = document.getElementById('documentationModal');
            modal.style.display = 'flex';
            setTimeout(() => { modal.classList.add('show'); }, 10);
            loadDocumentation();
        }

        function hideDocumentationView() {
            const modal = document.getElementById('documentationModal');
            modal.classList.remove('show');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }

        function loadDocumentation() {
            const docContent = document.getElementById('documentationContent');
            docContent.innerHTML = `<div class="loading-spinner"><div class="spinner"></div><p>جاري تحميل التوثيق اليومي من لوحة الإدارة...</p></div>`;
            fetchDocumentationFromSheets();
        }

        async function fetchDocumentationFromSheets() {
            try {
                const docSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTBKjdsCS_LNw-kqD-zFmsd-TuW7d-O4DOb9Cs-n1pP9U4oRz3l0mzM4VzGif1wM-S0mF7wW2bP6FxW/pub?gid=1233343337&single=true&output=csv';
                const response = await fetch(docSheetUrl);
                const csvText = await response.text();
                const data = parseDocumentationCSV(csvText);
                allDocumentationData = data;
                displayDocumentation(data);
            } catch (error) {
                console.error('خطأ في تحميل التوثيق:', error);
                displayDocumentationError();
            }
        }

        function parseDocumentationCSV(csvText) {
            const lines = csvText.split('\n');
            const documentation = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const values = parseCSVLine(line);
                    if (values.length >= 8) {
                        documentation.push({
                            date: values[0] || '', studentName: values[1] || 'غير محدد', grade: values[2] || '', section: values[3] || '', guardianPhone: values[4] || '', method: values[5] || '', handledBy: values[6] || '', time: values[7] || '', notes: values[8] || ''
                        });
                    }
                }
            }
            return documentation.reverse();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') { inQuotes = !inQuotes; } 
                else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else { current += char; }
            }
            result.push(current.trim());
            return result;
        }

        function displayDocumentation(docs, selectedDate = null) {
            const docContent = document.getElementById('documentationContent');
            
            let dateMessage = '';
            if (selectedDate) {
                const dateObj = new Date(selectedDate + 'T12:00:00+04:00');
                const gregorianDate = dateObj.toLocaleDateString('ar-OM', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                dateMessage = `<div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 15px; margin-bottom: 1.5rem; text-align: center; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);"><h4 style="margin: 0 0 0.5rem 0; font-size: 1.2rem;">📝 التوثيق اليومي المفلتر</h4><div style="font-size: 1.1rem; font-weight: 600;">📆 ${gregorianDate}</div></div>`;
            }
            
            if (docs.length === 0) {
                const noDataMessage = selectedDate ? `لا يوجد توثيق مسجل في التاريخ المحدد` : `لم يتم كتابة أي توثيق يومي بعد`;
                docContent.innerHTML = `${dateMessage}<div style="text-align: center; padding: 3rem; color: #64748b;"><div style="font-size: 4rem; margin-bottom: 1rem;">📝</div><h3>لا يوجد توثيق يومي</h3><p>${noDataMessage}</p>${selectedDate ? '<button class="control-btn all-btn" onclick="showAllDocumentation()" style="margin-top: 1rem;"><span class="icon">📋</span> عرض جميع التوثيقات</button>' : ''}</div>`;
                return;
            }

            const totalDocs = docs.length;
            const uniqueStudents = [...new Set(docs.map(doc => doc.studentName))].length;
            const callCount = docs.filter(doc => doc.method === 'Call' || doc.method === 'اتصال').length;
            const whatsappCount = docs.filter(doc => doc.method === 'WhatsApp' || doc.method === 'واتساب').length;

            docContent.innerHTML = `
                ${dateMessage}
                <div class="stats-container">
                    <div class="stat-card"><div class="stat-number" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${totalDocs}</div><div class="stat-label">إجمالي المتابعات</div></div>
                    <div class="stat-card"><div class="stat-number" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${uniqueStudents}</div><div class="stat-label">عدد الطالبات</div></div>
                    <div class="stat-card"><div class="stat-number" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${callCount}</div><div class="stat-label">📞 اتصالات</div></div>
                    <div class="stat-card"><div class="stat-number" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${whatsappCount}</div><div class="stat-label">💬 واتساب</div></div>
                </div>

                <table class="data-table">
                    <thead>
                        <tr><th>التاريخ</th><th>اسم الطالبة</th><th>الصف</th><th>الشعبة</th><th>هاتف ولي الأمر</th><th>طريقة التواصل (اتصال/واتساب)</th><th>تم التعامل بواسطة</th><th>الوقت</th><th>ملاحظات</th></tr>
                    </thead>
                    <tbody>
                        ${docs.map(doc => `
                            <tr>
                                <td style="line-height: 1.4; min-width: 120px;">${formatDocDate(doc.date)}</td>
                                <td style="font-weight: 600; color: #1e40af; min-width: 150px;">${doc.studentName}</td>
                                <td style="text-align: center; font-weight: 600; color: #059669;">${doc.grade}</td>
                                <td style="text-align: center; font-weight: 600; color: #7c3aed;">${doc.section}</td>
                                <td style="text-align: center; font-family: monospace; color: #dc2626; font-weight: 600;">${doc.guardianPhone}</td>
                                <td style="text-align: center;">
                                    <span style="background: ${doc.method === 'Call' || doc.method === 'اتصال' ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)'}; color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">
                                        ${doc.method === 'Call' ? '📞 اتصال' : doc.method === 'WhatsApp' ? '💬 واتساب' : doc.method}
                                    </span>
                                </td>
                                <td style="font-weight: 600; color: #f59e0b; min-width: 120px;">${doc.handledBy}</td>
                                <td style="text-align: center; font-family: monospace; color: #8b5cf6; font-weight: 600;">${doc.time}</td>
                                <td style="text-align: right; line-height: 1.6; max-width: 250px; padding: 0.8rem;">
                                    ${doc.notes ? `<div style="background: linear-gradient(135deg, #fef7ed 0%, #fed7aa 100%); padding: 0.8rem; border-radius: 8px; border-left: 3px solid #f59e0b; font-size: 0.9rem;">${doc.notes.replace(/\n/g, '<br>')}</div>` : `<span style="color: #94a3b8; font-style: italic; font-size: 0.9rem;">لا توجد ملاحظات</span>`}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div style="text-align: center; color: #64748b; font-size: 0.9rem; margin-top: 2rem; padding: 1.5rem; background: #f8fafc; border-radius: 15px; border: 1px solid #e2e8f0;">
                    <p style="margin: 0 0 0.5rem 0;">🏫 <strong>مدرسة أم مالك الأنصارية للبنات</strong></p>
                    <p style="margin: 0 0 0.5rem 0;">📝 سجل التوثيق اليومي - إعداد مديرة المدرسة: أحلام بنت علي الحمدانية</p>
                    <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">آخر تحديث: ${new Date().toLocaleDateString('ar-OM')} - ${new Date().toLocaleTimeString('ar-OM')}</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem;">📊 السجلات المعروضة: ${docs.length}</p>
                    ${selectedDate ? `<p style="margin: 0.5rem 0 0 0;">📋 <a href="#" onclick="showAllDocumentation()" style="color: #f59e0b; text-decoration: none;">عرض جميع التوثيقات</a></p>` : ''}
                </div>
            `;
        }

        function formatDocDate(dateString) {
            try {
                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        const date = new Date(parts[2], parts[1] - 1, parts[0]);
                        return date.toLocaleDateString('ar-OM', { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' });
                    }
                }
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('ar-OM', { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' });
                }
                return dateString;
            } catch (error) { return dateString || 'تاريخ غير محدد'; }
        }

        function setDocTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('docDateFilter').value = today;
            filterDocumentationByDate();
        }

        function showAllDocumentation() {
            document.getElementById('docDateFilter').value = '';
            displayDocumentation(allDocumentationData);
        }

        function filterDocumentationByDate() {
            const selectedDate = document.getElementById('docDateFilter').value;
            if (!selectedDate) {
                displayDocumentation(allDocumentationData);
                return;
            }

            const filteredData = allDocumentationData.filter(doc => {
                try {
                    const selectedDateObj = new Date(selectedDate);
                    const selectedDateString = selectedDateObj.toLocaleDateString('en-GB'); 
                    
                    if (doc.date.includes('/')) {
                        return doc.date === selectedDateString;
                    } else {
                        const docDate = new Date(doc.date);
                        const docDateString = docDate.toLocaleDateString('en-GB');
                        return docDateString === selectedDateString;
                    }
                } catch (error) { return false; }
            });

            displayDocumentation(filteredData, selectedDate);
        }

        function displayDocumentationError() {
            const docContent = document.getElementById('documentationContent');
            docContent.innerHTML = `<div style="text-align: center; padding: 3rem; color: #ef4444;"><div style="font-size: 4rem; margin-bottom: 1rem;">⚠️</div><h3>خطأ في تحميل التوثيق</h3><p>لم نتمكن من تحميل التوثيق اليومي من لوحة الإدارة</p><button class="control-btn refresh-btn" onclick="loadDocumentation()" style="margin-top: 1rem;"><span class="icon">🔄</span>إعادة المحاولة</button></div>`;
        }

        function refreshDocumentation() { loadDocumentation(); }
        function printDocumentation() { createDocumentationPrintContent(); setTimeout(() => { window.print(); }, 500); }

        function createDocumentationPrintContent() {
            const existingPrintContent = document.querySelector('.print-content');
            if (existingPrintContent) { existingPrintContent.remove(); }

            const dateFilter = document.getElementById('docDateFilter').value;
            let dataToPrint = allDocumentationData;
            let dateTitle = 'جميع التوثيقات';
            
            if (dateFilter) {
                dataToPrint = allDocumentationData.filter(doc => {
                    try {
                        const selectedDateObj = new Date(dateFilter);
                        const selectedDateString = selectedDateObj.toLocaleDateString('en-GB'); 
                        
                        if (doc.date.includes('/')) {
                            return doc.date === selectedDateString;
                        } else {
                            const docDate = new Date(doc.date);
                            const docDateString = docDate.toLocaleDateString('en-GB');
                            return docDateString === selectedDateString;
                        }
                    } catch (error) { return false; }
                });
                
                const dateObj = new Date(dateFilter + 'T12:00:00+04:00');
                dateTitle = dateObj.toLocaleDateString('ar-OM', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            }

            const printContent = document.createElement('div');
            printContent.className = 'print-content';
            printContent.style.display = 'none';
            
            printContent.innerHTML = `<div class="print-header"><div class="print-school-name">مدرسة أم مالك الأنصارية للبنات</div><div class="print-title">📝 سجل التوثيق اليومي</div><div class="print-date">📅 ${dateTitle}</div><div class="print-date">تاريخ الطباعة: ${new Date().toLocaleDateString('ar-OM')} - ${new Date().toLocaleTimeString('ar-OM')}</div></div>${dataToPrint.length > 0 ? `<table class="print-table"><thead><tr><th style="min-width: 10%;">التاريخ</th><th style="min-width: 15%;">اسم الطالبة</th><th style="min-width: 5%;">الصف</th><th style="min-width: 5%;">الشعبة</th><th style="min-width: 10%;">هاتف ولي الأمر</th><th style="min-width: 10%;">طريقة التواصل</th><th style="min-width: 10%;">تم التعامل بواسطة</th><th style="min-width: 10%;">الوقت</th><th style="min-width: 25%;">ملاحظات</th></tr></thead><tbody>${dataToPrint.map(doc => `<tr><td style="line-height: 1.4; font-size: 9pt;">${formatDocDate(doc.date)}</td><td style="font-weight: bold; color: #1e40af; font-size: 10pt;">${doc.studentName}</td><td>${doc.grade}</td><td>${doc.section}</td><td style="font-family: monospace;">${doc.guardianPhone}</td><td style="font-size: 9pt;"><span style="color: ${doc.method.includes('اتصال') || doc.method.includes('Call') ? '#059669' : '#16a34a'}; font-weight: bold;">${doc.method}</span></td><td style="font-weight: bold; color: #f59e0b; font-size: 9pt;">${doc.handledBy}</td><td>${doc.time}</td><td style="text-align: right; line-height: 1.4; font-size: 9pt;">${doc.notes.replace(/\n/g, '<br>')}</td></tr>`).join('')}</tbody></table>` : `<div style="text-align: center; padding: 30pt; color: #64748b; border: 1pt solid #e2e8f0; margin: 20pt 0;"><div style="font-size: 16pt; margin-bottom: 10pt;">📝</div><div style="font-size: 14pt; font-weight: bold;">لا يوجد توثيق يومي</div><div style="font-size: 12pt; margin-top: 5pt;">لم يتم كتابة أي توثيق في التاريخ المحدد</div></div>`}<div class="print-footer"><div>🏫 مدرسة أم مالك الأنصارية للبنات</div><div>📧 إعداد مديرة المدرسة: أحلام بنت علي الحمدانية</div><div>📝 عدد التوثيقات المطبوعة: ${dataToPrint.length}</div><div style="margin-top: 10pt; font-size: 8pt;">تم إنشاء هذا التقرير بواسطة نظام التوثيق اليومي الإلكتروني</div></div>`;
            document.body.appendChild(printContent);
        }
        
        // إخفاء نوافذ البيانات عند النقر خارجها
        document.getElementById('dataModal').addEventListener('click', function(event) {
            if (event.target === this) {
                hideDataView();
            }
        });
        document.getElementById('advancedStatsModal').addEventListener('click', function(event) {
            if (event.target === this) {
                hideAdvancedStats();
            }
        });
        document.getElementById('documentationModal').addEventListener('click', function(event) {
            if (event.target === this) {
                hideDocumentationView();
            }
        });
    </script>
</body>
</html>
